<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nghề Nghiệp Mơ Ước - AI Transformation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake { ani<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nghề Nghiệp Mơ Ước - AI Transformation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.2s ease-in-out 0s 2; }
        .fade-in-zoom {
            animation: fadeInZoom 0.7s ease-out forwards;
        }
        @keyframes fadeInZoom {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-8 md:mb-12">
            <div class="inline-block bg-indigo-100 text-indigo-700 px-4 py-1 rounded-full text-xs md:sm font-bold mb-3 uppercase tracking-wider">AI Studio Web (HTML Version)</div>
            <h1 class="text-3xl md:text-5xl font-extrabold text-indigo-900 mb-2 leading-tight">Nghề Nghiệp Mơ Ước</h1>
            <p class="text-slate-600 max-w-2xl mx-auto italic text-sm md:text-base">"Khám phá phiên bản trưởng thành của bạn qua sức mạnh AI"</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8 items-start">
            <!-- Cột trái: Cấu hình -->
            <div class="bg-white p-5 md:p-8 rounded-2xl md:rounded-3xl shadow-xl border border-slate-100">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg md:text-xl font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="wand-2" class="w-5 h-5 text-indigo-500"></i> Cấu hình
                    </h2>
                    <button onclick="resetApp()" class="text-slate-400 hover:text-red-500 flex items-center gap-1 text-xs md:text-sm transition-colors">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i> Làm mới
                    </button>
                </div>

                <div class="space-y-6">
                    <!-- Input Nghề Nghiệp -->
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">1. Nghề nghiệp của em trong tương lai</label>
                        <div class="relative">
                            <i data-lucide="briefcase" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
                            <input
                                id="description"
                                type="text"
                                placeholder="VD: Họa sĩ, Bác sĩ, Giám đốc..."
                                class="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all text-sm md:text-base"
                            />
                        </div>
                    </div>

                    <!-- Input Hình ảnh -->
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">2. Hình ảnh hiện tại của em</label>
                        
                        <!-- Camera View -->
                        <div id="camera-container" class="hidden relative rounded-xl md:rounded-2xl overflow-hidden bg-black aspect-video border-2 border-indigo-500 shadow-inner">
                            <video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
                            <div class="absolute bottom-4 left-0 right-0 flex justify-center gap-3">
                                <button onclick="capturePhoto()" class="bg-white text-indigo-600 p-4 rounded-full shadow-xl hover:bg-indigo-50 transition-all active:scale-90">
                                    <i data-lucide="camera" class="w-6 h-6 md:w-7 md:h-7"></i>
                                </button>
                                <button onclick="stopCamera()" class="bg-red-500 text-white p-4 rounded-full shadow-xl hover:bg-red-600 transition-all active:scale-90">
                                    <i data-lucide="x" class="w-6 h-6 md:w-7 md:h-7"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Upload/Camera Selection -->
                        <div id="selection-container" class="grid grid-cols-2 gap-3 md:gap-4">
                            <button onclick="startCamera()" class="flex flex-col items-center justify-center p-4 md:p-6 border-2 border-dashed border-slate-200 rounded-xl md:rounded-2xl hover:border-indigo-400 hover:bg-indigo-50 transition-all group">
                                <i data-lucide="camera" class="w-6 h-6 md:w-8 md:h-8 text-slate-400 group-hover:text-indigo-500 mb-2"></i>
                                <span class="text-[10px] md:text-xs font-bold text-slate-500 group-hover:text-indigo-600">Dùng Camera</span>
                            </button>
                            <label class="flex flex-col items-center justify-center p-4 md:p-6 border-2 border-dashed border-slate-200 rounded-xl md:rounded-2xl hover:border-indigo-400 hover:bg-indigo-50 cursor-pointer transition-all group">
                                <input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleFileUpload(event)">
                                <i data-lucide="upload" class="w-6 h-6 md:w-8 md:h-8 text-slate-400 group-hover:text-indigo-500 mb-2"></i>
                                <span class="text-[10px] md:text-xs font-bold text-slate-500 group-hover:text-indigo-600">Tải ảnh lên</span>
                            </label>
                        </div>

                        <!-- Preview Container -->
                        <div id="preview-container" class="hidden mt-4 relative rounded-xl md:rounded-2xl overflow-hidden border border-indigo-100 shadow-sm group aspect-video lg:aspect-auto lg:h-48">
                            <img id="preview-img" src="" alt="Preview" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" />
                            <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex items-center justify-center gap-2 transition-opacity">
                                <button onclick="downloadRawImage()" class="p-3 bg-white text-indigo-600 rounded-full hover:bg-indigo-50 shadow-lg transition-transform hover:scale-110">
                                    <i data-lucide="download" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div class="absolute bottom-2 left-2 bg-white/90 backdrop-blur px-2 py-1 rounded text-[9px] md:text-[10px] font-bold text-indigo-700 shadow-sm flex items-center gap-1">
                                <i data-lucide="camera" class="w-3 h-3"></i> ẢNH GỐC
                            </div>
                        </div>
                    </div>

                    <button id="generate-btn" onclick="generateDreamJob()" class="w-full py-3 md:py-4 rounded-xl font-bold text-white flex items-center justify-center gap-3 shadow-lg transition-all text-sm md:text-base bg-indigo-600 hover:bg-indigo-700 active:scale-[0.98]">
                        <span id="btn-text" class="flex items-center gap-2">
                            <i data-lucide="wand-2" class="w-5 h-5 md:w-6 md:h-6"></i> Xem sự thay đổi
                        </span>
                    </button>

                    <div id="error-box" class="hidden p-3 bg-red-50 text-red-600 text-[10px] md:text-xs rounded-xl border border-red-100 text-center"></div>
                </div>
            </div>

            <!-- Cột phải: Kết quả -->
            <div class="space-y-6 w-full">
                <div class="bg-white p-2 rounded-2xl md:rounded-3xl shadow-xl border border-slate-100 overflow-hidden min-h-[350px] md:min-h-[500px] flex flex-col">
                    <!-- Placeholder -->
                    <div id="result-placeholder" class="flex-1 flex flex-col items-center justify-center text-center p-8 opacity-40">
                        <i data-lucide="camera" class="w-12 h-12 md:w-16 md:h-16 mb-4 text-slate-300"></i>
                        <p class="text-xs md:text-sm font-medium text-slate-500">Kết quả dự đoán sẽ hiển thị ở đây</p>
                    </div>

                    <!-- Loading -->
                    <div id="result-loading" class="hidden flex-1 flex flex-col items-center justify-center p-8">
                        <div class="w-16 h-16 md:w-20 md:h-20 border-4 border-indigo-100 border-t-indigo-500 rounded-full animate-spin mb-6"></div>
                        <div class="space-y-2 text-center">
                            <p class="text-indigo-900 font-bold text-base md:text-lg">AI đang phân tích khuôn mặt...</p>
                            <p class="text-slate-400 text-xs">Quá trình này có thể mất 10-20 giây</p>
                        </div>
                    </div>

                    <!-- Result Content -->
                    <div id="result-content" class="hidden fade-in-zoom p-2 flex flex-col h-full">
                        <img id="result-img" src="" alt="Kết quả" class="w-full h-auto rounded-xl md:rounded-2xl shadow-sm" />
                        <div class="mt-4 md:mt-6 p-5 md:p-6 bg-indigo-900 rounded-xl md:rounded-2xl text-white">
                            <div class="mb-4">
                                <span class="text-[10px] uppercase tracking-widest text-indigo-300 font-bold">Chân dung tương lai</span>
                                <h4 id="result-title" class="text-lg md:text-xl font-bold leading-tight">Nghề Nghiệp (Phiên bản trưởng thành)</h4>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-3">
                                <button onclick="downloadResult()" class="flex-1 py-3 bg-white text-indigo-900 rounded-xl font-bold flex items-center justify-center gap-2 text-sm hover:bg-indigo-50 transition-all active:scale-95">
                                    <i data-lucide="download" class="w-4 h-4"></i> Tải kết quả
                                </button>
                                <button onclick="resetApp()" class="py-3 px-6 bg-white/10 rounded-xl font-bold text-sm hover:bg-white/20 transition-all active:scale-95 border border-white/10">
                                    Làm mới
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <p class="text-[10px] text-slate-400 text-center px-4">
                    * Ứng dụng hoạt động tốt nhất trên Chrome, Safari và Edge phiên bản mới nhất.
                </p>
            </div>
        </div>
    </div>

    <!-- Hidden Canvas for Photo Capture -->
    <canvas id="canvas" class="hidden"></canvas>

    <script>
        const apiKey = ""; // API Key tự động cấp
        let currentBase64 = null;
        let currentPreviewUrl = null;
        let currentResultBase64 = null;
        let stream = null;

        // Initialize Icons
        lucide.createIcons();

        // Elements
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const previewImg = document.getElementById('preview-img');
        const previewContainer = document.getElementById('preview-container');
        const selectionContainer = document.getElementById('selection-container');
        const cameraContainer = document.getElementById('camera-container');
        const descriptionInput = document.getElementById('description');
        const errorBox = document.getElementById('error-box');
        const btnText = document.getElementById('btn-text');
        const generateBtn = document.getElementById('generate-btn');

        const resultPlaceholder = document.getElementById('result-placeholder');
        const resultLoading = document.getElementById('result-loading');
        const resultContent = document.getElementById('result-content');
        const resultImg = document.getElementById('result-img');
        const resultTitle = document.getElementById('result-title');

        async function startCamera() {
            showError(null);
            cameraContainer.classList.remove('hidden');
            selectionContainer.classList.add('hidden');
            previewContainer.classList.add('hidden');

            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                video.srcObject = stream;
            } catch (err) {
                showError("Không thể truy cập camera. Vui lòng kiểm tra quyền trình duyệt.");
                stopCamera();
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            video.srcObject = null;
            cameraContainer.classList.add('hidden');
            selectionContainer.classList.remove('hidden');
            if (currentPreviewUrl) previewContainer.classList.remove('hidden');
        }

        function capturePhoto() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            const dataUrl = canvas.toDataURL('image/png');
            currentPreviewUrl = dataUrl;
            currentBase64 = dataUrl.split(',')[1];
            
            previewImg.src = dataUrl;
            stopCamera();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentPreviewUrl = e.target.result;
                    currentBase64 = e.target.result.split(',')[1];
                    previewImg.src = currentPreviewUrl;
                    previewContainer.classList.remove('hidden');
                    showError(null);
                };
                reader.readAsDataURL(file);
            }
        }

        async function generateDreamJob() {
            const desc = descriptionInput.value.trim();
            if (!desc || !currentBase64) {
                showError("Vui lòng nhập nghề nghiệp và cung cấp ảnh chân dung.");
                return;
            }

            setLoading(true);
            showError(null);

            const prompt = `Transform the person in the provided image into a professional ${desc}. 
            The person should appear to be a mature adult between 24 and 30 years old. 
            Maintain the same facial features, bone structure, and facial identity as the original person but aged up to adulthood. 
            They should be wearing professional attire suitable for a ${desc} in a realistic workplace environment. 
            Photorealistic, cinematic lighting, 8k resolution.`;

            let success = false;
            let retries = 0;
            const delays = [1000, 2000, 4000, 8000];

            while (!success && retries < 5) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: prompt },
                                    { inlineData: { mimeType: "image/png", data: currentBase64 } }
                                ]
                            }],
                            generationConfig: { responseModalities: ['TEXT', 'IMAGE'] }
                        })
                    });

                    if (!response.ok) throw new Error();

                    const data = await response.json();
                    const base64Res = data.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                    
                    if (base64Res) {
                        currentResultBase64 = `data:image/png;base64,${base64Res}`;
                        resultImg.src = currentResultBase64;
                        resultTitle.innerText = `${desc} (Phiên bản trưởng thành)`;
                        success = true;
                    } else {
                        throw new Error();
                    }
                } catch (err) {
                    if (retries < 4) {
                        await new Promise(r => setTimeout(r, delays[retries]));
                        retries++;
                    } else {
                        showError("Có lỗi xảy ra khi tạo ảnh. Vui lòng thử lại sau.");
                        setLoading(false);
                        return;
                    }
                }
            }

            setLoading(false);
            showResult(true);
        }

        function setLoading(isLoading) {
            generateBtn.disabled = isLoading;
            if (isLoading) {
                btnText.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> Đang xử lý...';
                resultPlaceholder.classList.add('hidden');
                resultContent.classList.add('hidden');
                resultLoading.classList.remove('hidden');
            } else {
                btnText.innerHTML = '<i data-lucide="wand-2" class="w-5 h-5"></i> Xem sự thay đổi';
                resultLoading.classList.add('hidden');
            }
            lucide.createIcons();
        }

        function showResult(isVisible) {
            if (isVisible) {
                resultContent.classList.remove('hidden');
                resultPlaceholder.classList.add('hidden');
            } else {
                resultContent.classList.add('hidden');
                resultPlaceholder.classList.remove('hidden');
            }
        }

        function showError(msg) {
            if (msg) {
                errorBox.innerText = msg;
                errorBox.classList.remove('hidden');
                errorBox.classList.add('animate-shake');
                setTimeout(() => errorBox.classList.remove('animate-shake'), 500);
            } else {
                errorBox.classList.add('hidden');
            }
        }

        function resetApp() {
            descriptionInput.value = '';
            currentBase64 = null;
            currentPreviewUrl = null;
            currentResultBase64 = null;
            previewContainer.classList.add('hidden');
            showResult(false);
            showError(null);
            stopCamera();
        }

        function downloadRawImage() {
            if (!currentPreviewUrl) return;
            const a = document.createElement('a');
            a.href = currentPreviewUrl;
            a.download = 'anh-goc.png';
            a.click();
        }

        function downloadResult() {
            if (!currentResultBase64) return;
            const a = document.createElement('a');
            a.href = currentResultBase64;
            a.download = `tuong-lai-${descriptionInput.value}.png`;
            a.click();
        }
    </script>
</body>
</html>
